/*
this version of code is pretty the earliest verison of code already and i think its generated and fix and upgraded from
chatgpt-5 and claude sonnet 4.5
its has too many flaws and could got too many signals to i have already upgraded to a better version.
*/





//@version=5
indicator("MTF EMA Á°ÆËÆ§‰ø°Âè∑ [Pro]", overlay=true, max_labels_count=500)

// ============================================
// üìå ÂèØ‰øÆÊîπÂèÇÊï∞Âå∫Âüü
// ============================================
ema_fast = input.int(9, "Âø´Á∫øEMAÂë®Êúü", minval=1, group="EMAËÆæÁΩÆ")
ema_slow = input.int(21, "ÊÖ¢Á∫øEMAÂë®Êúü", minval=1, group="EMAËÆæÁΩÆ")
slope_length = input.int(1, "ÊñúÁéáËÆ°ÁÆóÂë®Êúü", minval=1, group="EMAËÆæÁΩÆ")

tf1 = input.timeframe("5", "Êó∂Èó¥Ê°ÜÊû∂1", group="Êó∂Èó¥Ê°ÜÊû∂")
weight1 = input.float(1.0, "ÊùÉÈáç1", minval=0.1, maxval=5.0, step=0.1, group="Êó∂Èó¥Ê°ÜÊû∂")

tf2 = input.timeframe("10", "Êó∂Èó¥Ê°ÜÊû∂2", group="Êó∂Èó¥Ê°ÜÊû∂")
weight2 = input.float(1.5, "ÊùÉÈáç2", minval=0.1, maxval=5.0, step=0.1, group="Êó∂Èó¥Ê°ÜÊû∂")

tf3 = input.timeframe("30", "Êó∂Èó¥Ê°ÜÊû∂3", group="Êó∂Èó¥Ê°ÜÊû∂")
weight3 = input.float(2.0, "ÊùÉÈáç3", minval=0.1, maxval=5.0, step=0.1, group="Êó∂Èó¥Ê°ÜÊû∂")

tf4 = input.timeframe("60", "Êó∂Èó¥Ê°ÜÊû∂4", group="Êó∂Èó¥Ê°ÜÊû∂")
weight4 = input.float(3.0, "ÊùÉÈáç4", minval=0.1, maxval=5.0, step=0.1, group="Êó∂Èó¥Ê°ÜÊû∂")

signal_threshold = input.float(5.0, "‰ø°Âè∑ÈòàÂÄºÂàÜÊï∞", minval=0, step=0.5, group="‰ø°Âè∑ËÆæÁΩÆ")
gate_mode = input.bool(false, "ÂêØÁî®Èó®ÊéßÊ®°Âºè", group="‰ø°Âè∑ËÆæÁΩÆ")
cooldown_bars = input.int(5, "ÂÜ∑Âç¥Êúü(KÁ∫øÊï∞)", minval=0, group="‰ø°Âè∑ËÆæÁΩÆ")

use_confirmed = input.bool(true, "Èò≤ÈáçÁªòÊ®°Âºè", group="È´òÁ∫ßËÆæÁΩÆ")

use_atr_filter = input.bool(false, "ÂêØÁî®ATRÊ≥¢Âä®ÁéáËøáÊª§", group="ËøáÊª§Âô®")
atr_length = input.int(14, "ATRÂë®Êúü", minval=1, group="ËøáÊª§Âô®")
atr_threshold = input.float(0.5, "ÊúÄ‰ΩéATR%", minval=0, step=0.1, group="ËøáÊª§Âô®")

use_cmf_filter = input.bool(false, "ÂêØÁî®CMFËµÑÈáëÊµÅËøáÊª§", group="ËøáÊª§Âô®")
cmf_length = input.int(20, "CMFÂë®Êúü", minval=1, group="ËøáÊª§Âô®")
cmf_threshold = input.float(0.0, "CMFÈòàÂÄº", minval=-1.0, maxval=1.0, step=0.05, group="ËøáÊª§Âô®")

show_ema_current = input.bool(true, "ÊòæÁ§∫ÂΩìÂâçÂë®ÊúüEMAÁ∫ø", group="ÊòæÁ§∫")
show_mtf_status = input.bool(true, "ÊòæÁ§∫Â§öÈó¥Ê°ÜÊû∂Áä∂ÊÄÅË°®", group="ÊòæÁ§∫")
show_score = input.bool(true, "Âú®Ê†áÁ≠æ‰∏äÊòæÁ§∫ÂàÜÊï∞", group="ÊòæÁ§∫")

// ============================================
// CMFËÆ°ÁÆóÂáΩÊï∞
// ============================================
cmf_calc(len) =>
    ad = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
    math.sum(ad, len) / math.sum(volume, len)

// ============================================
// EMAË∂ãÂäøÂà§Êñ≠ÂáΩÊï∞
// ============================================
get_ema_trend(simple string tf, float weight) =>
    ema_fast_val = request.security(syminfo.tickerid, tf, ta.ema(close, ema_fast), lookahead=barmerge.lookahead_off)
    ema_slow_val = request.security(syminfo.tickerid, tf, ta.ema(close, ema_slow), lookahead=barmerge.lookahead_off)
    ema_fast_prev = request.security(syminfo.tickerid, tf, ta.ema(close[slope_length], ema_fast), lookahead=barmerge.lookahead_off)
    ema_slow_prev = request.security(syminfo.tickerid, tf, ta.ema(close[slope_length], ema_slow), lookahead=barmerge.lookahead_off)
    is_confirmed = request.security(syminfo.tickerid, tf, barstate.isconfirmed, lookahead=barmerge.lookahead_off)
    
    trend_result = 0
    score_result = 0.0
    confirmed_result = true
    
    if use_confirmed and not is_confirmed
        trend_result := 0
        confirmed_result := false
    else
        fast_slope = ema_fast_val - ema_fast_prev
        slow_slope = ema_slow_val - ema_slow_prev
        
        if ema_fast_val > ema_slow_val and fast_slope > 0 and slow_slope > 0
            trend_result := 1
            score_result := weight
        else if ema_fast_val < ema_slow_val and fast_slope < 0 and slow_slope < 0
            trend_result := -1
            score_result := weight
    
    [trend_result, ema_fast_val, ema_slow_val, confirmed_result, score_result]

// ============================================
// Ëé∑Âèñ4‰∏™Êó∂Èó¥Ê°ÜÊû∂ÁöÑË∂ãÂäø
// ============================================
[trend1, ema9_tf1, ema21_tf1, confirmed1, score1] = get_ema_trend(tf1, weight1)
[trend2, ema9_tf2, ema21_tf2, confirmed2, score2] = get_ema_trend(tf2, weight2)
[trend3, ema9_tf3, ema21_tf3, confirmed3, score3] = get_ema_trend(tf3, weight3)
[trend4, ema9_tf4, ema21_tf4, confirmed4, score4] = get_ema_trend(tf4, weight4)

// ============================================
// Âä†ÊùÉÊäïÁ•®ËÆ°ÁÆó
// ============================================
bullish_score = (trend1 == 1 ? score1 : 0) + (trend2 == 1 ? score2 : 0) + (trend3 == 1 ? score3 : 0) + (trend4 == 1 ? score4 : 0)
bearish_score = (trend1 == -1 ? score1 : 0) + (trend2 == -1 ? score2 : 0) + (trend3 == -1 ? score3 : 0) + (trend4 == -1 ? score4 : 0)
max_score = weight1 + weight2 + weight3 + weight4

gate_passed_bull = not gate_mode or trend4 == 1
gate_passed_bear = not gate_mode or trend4 == -1

// ============================================
// ATRÊ≥¢Âä®ÁéáËøáÊª§
// ============================================
atr_value = ta.atr(atr_length)
atr_percent = atr_value / close * 100
atr_pass = not use_atr_filter or atr_percent >= atr_threshold

// ============================================
// CMFËµÑÈáëÊµÅËøáÊª§
// ============================================
cmf_val = cmf_calc(cmf_length)
cmf_pass_bull = not use_cmf_filter or cmf_val > cmf_threshold
cmf_pass_bear = not use_cmf_filter or cmf_val < -cmf_threshold

// ============================================
// ‰ø°Âè∑ÁîüÊàêÈÄªËæë
// ============================================
var int last_signal_bar = 0
cooldown_passed = bar_index - last_signal_bar >= cooldown_bars

buy_signal = bullish_score >= signal_threshold and gate_passed_bull and atr_pass and cmf_pass_bull and cooldown_passed
sell_signal = bearish_score >= signal_threshold and gate_passed_bear and atr_pass and cmf_pass_bear and cooldown_passed

buy_signal_new = buy_signal and not buy_signal[1]
sell_signal_new = sell_signal and not sell_signal[1]

if buy_signal_new or sell_signal_new
    last_signal_bar := bar_index

// ============================================
// ÁªòÂà∂EMAÁ∫ø
// ============================================
current_ema9 = ta.ema(close, ema_fast)
current_ema21 = ta.ema(close, ema_slow)

plot(show_ema_current ? current_ema9 : na, "EMA9", color=color.new(color.blue, 0), linewidth=2)
plot(show_ema_current ? current_ema21 : na, "EMA21", color=color.new(color.orange, 0), linewidth=2)

// ============================================
// ÁªòÂà∂‰π∞Âçñ‰ø°Âè∑
// ============================================
plotshape(buy_signal_new, "‰π∞ÂÖ•‰ø°Âè∑", shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.normal)
plotshape(sell_signal_new, "ÂçñÂá∫‰ø°Âè∑", shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.normal)

// ============================================
// ‰ø°Âè∑Ê†áÁ≠æ
// ============================================
if buy_signal_new
    signal_text = "‰π∞ÂÖ•‰ø°Âè∑" + (show_score ? " [" + str.tostring(bullish_score, "#.#") + "/" + str.tostring(max_score, "#.#") + "]\n" : "\n") + (trend1 == 1 ? "‚úì " + tf1 + " [" + str.tostring(weight1, "#.#") + "]\n" : "") + (trend2 == 1 ? "‚úì " + tf2 + " [" + str.tostring(weight2, "#.#") + "]\n" : "") + (trend3 == 1 ? "‚úì " + tf3 + " [" + str.tostring(weight3, "#.#") + "]\n" : "") + (trend4 == 1 ? "‚úì " + tf4 + " [" + str.tostring(weight4, "#.#") + "]" : "")
    label.new(bar_index, low, signal_text, style=label.style_label_up, color=color.new(color.green, 80), textcolor=color.white, size=size.small)

if sell_signal_new
    signal_text = "ÂçñÂá∫‰ø°Âè∑" + (show_score ? " [" + str.tostring(bearish_score, "#.#") + "/" + str.tostring(max_score, "#.#") + "]\n" : "\n") + (trend1 == -1 ? "‚úì " + tf1 + " [" + str.tostring(weight1, "#.#") + "]\n" : "") + (trend2 == -1 ? "‚úì " + tf2 + " [" + str.tostring(weight2, "#.#") + "]\n" : "") + (trend3 == -1 ? "‚úì " + tf3 + " [" + str.tostring(weight3, "#.#") + "]\n" : "") + (trend4 == -1 ? "‚úì " + tf4 + " [" + str.tostring(weight4, "#.#") + "]" : "")
    label.new(bar_index, high, signal_text, style=label.style_label_down, color=color.new(color.red, 80), textcolor=color.white, size=size.small)

// ============================================
// Áä∂ÊÄÅË°®Ê†º
// ============================================
if show_mtf_status and barstate.islast
    var table status_table = table.new(position.top_right, 4, 6, border_width=1, border_color=color.gray)
    
    if barstate.isfirst
        table.cell(status_table, 0, 0, "Âë®Êúü", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 1, 0, "Ë∂ãÂäø", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 2, 0, "ÊùÉÈáç", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 3, 0, "ÂæóÂàÜ", bgcolor=color.new(color.gray, 70), text_color=color.white)
    
    table.cell(status_table, 0, 1, tf1, text_color=color.white)
    table.cell(status_table, 1, 1, trend1 == 1 ? "‚Üë" : trend1 == -1 ? "‚Üì" : "‚Äî", bgcolor=trend1 == 1 ? color.new(color.green, 70) : trend1 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 1, str.tostring(weight1, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 1, str.tostring(score1, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 2, tf2, text_color=color.white)
    table.cell(status_table, 1, 2, trend2 == 1 ? "‚Üë" : trend2 == -1 ? "‚Üì" : "‚Äî", bgcolor=trend2 == 1 ? color.new(color.green, 70) : trend2 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 2, str.tostring(weight2, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 2, str.tostring(score2, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 3, tf3, text_color=color.white)
    table.cell(status_table, 1, 3, trend3 == 1 ? "‚Üë" : trend3 == -1 ? "‚Üì" : "‚Äî", bgcolor=trend3 == 1 ? color.new(color.green, 70) : trend3 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 3, str.tostring(weight3, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 3, str.tostring(score3, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 4, tf4, text_color=color.white)
    table.cell(status_table, 1, 4, trend4 == 1 ? "‚Üë" : trend4 == -1 ? "‚Üì" : "‚Äî", bgcolor=trend4 == 1 ? color.new(color.green, 70) : trend4 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 4, str.tostring(weight4, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 4, str.tostring(score4, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 5, "ÊÄªÂàÜ", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 1, 5, bullish_score > bearish_score ? "‚Üë" : bearish_score > bullish_score ? "‚Üì" : "‚Äî", bgcolor=bullish_score > bearish_score ? color.new(color.green, 70) : bearish_score > bullish_score ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 5, str.tostring(max_score, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 5, str.tostring(math.max(bullish_score, bearish_score), "#.#") + "/" + str.tostring(signal_threshold, "#.#"), text_color=bullish_score >= signal_threshold or bearish_score >= signal_threshold ? color.yellow : color.white)

alertcondition(buy_signal_new, "‰π∞ÂÖ•‰ø°Âè∑", "Â§öÊó∂Èó¥Ê°ÜÊû∂Á°ÆËÆ§‰π∞ÂÖ•‰ø°Âè∑")
alertcondition(sell_signal_new, "ÂçñÂá∫‰ø°Âè∑", "Â§öÊó∂Èó¥Ê°ÜÊû∂Á°ÆËÆ§ÂçñÂá∫‰ø°Âè∑")

bgcolor(buy_signal ? color.new(color.green, 95) : sell_signal ? color.new(color.red, 95) : na)
