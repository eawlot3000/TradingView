/*
this version of code is pretty the earliest verison of code already and i think its generated and fix and upgraded from
chatgpt-5 and claude sonnet 4.5
its has too many flaws and could got too many signals to i have already upgraded to a better version.
*/





//@version=5
indicator("MTF EMA ç¡®è®¤ä¿¡å· [Pro]", overlay=true, max_labels_count=500)

// ============================================
// ğŸ“Œ å¯ä¿®æ”¹å‚æ•°åŒºåŸŸ
// ============================================
ema_fast = input.int(9, "å¿«çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
ema_slow = input.int(21, "æ…¢çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
slope_length = input.int(1, "æ–œç‡è®¡ç®—å‘¨æœŸ", minval=1, group="EMAè®¾ç½®")

tf1 = input.timeframe("5", "æ—¶é—´æ¡†æ¶1", group="æ—¶é—´æ¡†æ¶")
weight1 = input.float(1.0, "æƒé‡1", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf2 = input.timeframe("10", "æ—¶é—´æ¡†æ¶2", group="æ—¶é—´æ¡†æ¶")
weight2 = input.float(1.5, "æƒé‡2", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf3 = input.timeframe("30", "æ—¶é—´æ¡†æ¶3", group="æ—¶é—´æ¡†æ¶")
weight3 = input.float(2.0, "æƒé‡3", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf4 = input.timeframe("60", "æ—¶é—´æ¡†æ¶4", group="æ—¶é—´æ¡†æ¶")
weight4 = input.float(3.0, "æƒé‡4", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

signal_threshold = input.float(5.0, "ä¿¡å·é˜ˆå€¼åˆ†æ•°", minval=0, step=0.5, group="ä¿¡å·è®¾ç½®")
gate_mode = input.bool(false, "å¯ç”¨é—¨æ§æ¨¡å¼", group="ä¿¡å·è®¾ç½®")
cooldown_bars = input.int(5, "å†·å´æœŸ(Kçº¿æ•°)", minval=0, group="ä¿¡å·è®¾ç½®")

use_confirmed = input.bool(true, "é˜²é‡ç»˜æ¨¡å¼", group="é«˜çº§è®¾ç½®")

use_atr_filter = input.bool(false, "å¯ç”¨ATRæ³¢åŠ¨ç‡è¿‡æ»¤", group="è¿‡æ»¤å™¨")
atr_length = input.int(14, "ATRå‘¨æœŸ", minval=1, group="è¿‡æ»¤å™¨")
atr_threshold = input.float(0.5, "æœ€ä½ATR%", minval=0, step=0.1, group="è¿‡æ»¤å™¨")

use_cmf_filter = input.bool(false, "å¯ç”¨CMFèµ„é‡‘æµè¿‡æ»¤", group="è¿‡æ»¤å™¨")
cmf_length = input.int(20, "CMFå‘¨æœŸ", minval=1, group="è¿‡æ»¤å™¨")
cmf_threshold = input.float(0.0, "CMFé˜ˆå€¼", minval=-1.0, maxval=1.0, step=0.05, group="è¿‡æ»¤å™¨")

show_ema_current = input.bool(true, "æ˜¾ç¤ºå½“å‰å‘¨æœŸEMAçº¿", group="æ˜¾ç¤º")
show_mtf_status = input.bool(true, "æ˜¾ç¤ºå¤šé—´æ¡†æ¶çŠ¶æ€è¡¨", group="æ˜¾ç¤º")
show_score = input.bool(true, "åœ¨æ ‡ç­¾ä¸Šæ˜¾ç¤ºåˆ†æ•°", group="æ˜¾ç¤º")

// ============================================
// CMFè®¡ç®—å‡½æ•°
// ============================================
cmf_calc(len) =>
    ad = close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume
    math.sum(ad, len) / math.sum(volume, len)

// ============================================
// EMAè¶‹åŠ¿åˆ¤æ–­å‡½æ•°
// ============================================
get_ema_trend(simple string tf, float weight) =>
    ema_fast_val = request.security(syminfo.tickerid, tf, ta.ema(close, ema_fast), lookahead=barmerge.lookahead_off)
    ema_slow_val = request.security(syminfo.tickerid, tf, ta.ema(close, ema_slow), lookahead=barmerge.lookahead_off)
    ema_fast_prev = request.security(syminfo.tickerid, tf, ta.ema(close[slope_length], ema_fast), lookahead=barmerge.lookahead_off)
    ema_slow_prev = request.security(syminfo.tickerid, tf, ta.ema(close[slope_length], ema_slow), lookahead=barmerge.lookahead_off)
    is_confirmed = request.security(syminfo.tickerid, tf, barstate.isconfirmed, lookahead=barmerge.lookahead_off)
    
    trend_result = 0
    score_result = 0.0
    confirmed_result = true
    
    if use_confirmed and not is_confirmed
        trend_result := 0
        confirmed_result := false
    else
        fast_slope = ema_fast_val - ema_fast_prev
        slow_slope = ema_slow_val - ema_slow_prev
        
        if ema_fast_val > ema_slow_val and fast_slope > 0 and slow_slope > 0
            trend_result := 1
            score_result := weight
        else if ema_fast_val < ema_slow_val and fast_slope < 0 and slow_slope < 0
            trend_result := -1
            score_result := weight
    
    [trend_result, ema_fast_val, ema_slow_val, confirmed_result, score_result]

// ============================================
// è·å–4ä¸ªæ—¶é—´æ¡†æ¶çš„è¶‹åŠ¿
// ============================================
[trend1, ema9_tf1, ema21_tf1, confirmed1, score1] = get_ema_trend(tf1, weight1)
[trend2, ema9_tf2, ema21_tf2, confirmed2, score2] = get_ema_trend(tf2, weight2)
[trend3, ema9_tf3, ema21_tf3, confirmed3, score3] = get_ema_trend(tf3, weight3)
[trend4, ema9_tf4, ema21_tf4, confirmed4, score4] = get_ema_trend(tf4, weight4)

// ============================================
// åŠ æƒæŠ•ç¥¨è®¡ç®—
// ============================================
bullish_score = (trend1 == 1 ? score1 : 0) + (trend2 == 1 ? score2 : 0) + (trend3 == 1 ? score3 : 0) + (trend4 == 1 ? score4 : 0)
bearish_score = (trend1 == -1 ? score1 : 0) + (trend2 == -1 ? score2 : 0) + (trend3 == -1 ? score3 : 0) + (trend4 == -1 ? score4 : 0)
max_score = weight1 + weight2 + weight3 + weight4

gate_passed_bull = not gate_mode or trend4 == 1
gate_passed_bear = not gate_mode or trend4 == -1

// ============================================
// ATRæ³¢åŠ¨ç‡è¿‡æ»¤
// ============================================
atr_value = ta.atr(atr_length)
atr_percent = atr_value / close * 100
atr_pass = not use_atr_filter or atr_percent >= atr_threshold

// ============================================
// CMFèµ„é‡‘æµè¿‡æ»¤
// ============================================
cmf_val = cmf_calc(cmf_length)
cmf_pass_bull = not use_cmf_filter or cmf_val > cmf_threshold
cmf_pass_bear = not use_cmf_filter or cmf_val < -cmf_threshold

// ============================================
// ä¿¡å·ç”Ÿæˆé€»è¾‘
// ============================================
var int last_signal_bar = 0
cooldown_passed = bar_index - last_signal_bar >= cooldown_bars

buy_signal = bullish_score >= signal_threshold and gate_passed_bull and atr_pass and cmf_pass_bull and cooldown_passed
sell_signal = bearish_score >= signal_threshold and gate_passed_bear and atr_pass and cmf_pass_bear and cooldown_passed

buy_signal_new = buy_signal and not buy_signal[1]
sell_signal_new = sell_signal and not sell_signal[1]

if buy_signal_new or sell_signal_new
    last_signal_bar := bar_index

// ============================================
// ç»˜åˆ¶EMAçº¿
// ============================================
current_ema9 = ta.ema(close, ema_fast)
current_ema21 = ta.ema(close, ema_slow)

plot(show_ema_current ? current_ema9 : na, "EMA9", color=color.new(color.blue, 0), linewidth=2)
plot(show_ema_current ? current_ema21 : na, "EMA21", color=color.new(color.orange, 0), linewidth=2)

// ============================================
// ç»˜åˆ¶ä¹°å–ä¿¡å·
// ============================================
plotshape(buy_signal_new, "ä¹°å…¥ä¿¡å·", shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.normal)
plotshape(sell_signal_new, "å–å‡ºä¿¡å·", shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.normal)

// ============================================
// ä¿¡å·æ ‡ç­¾
// ============================================
if buy_signal_new
    signal_text = "ä¹°å…¥ä¿¡å·" + (show_score ? " [" + str.tostring(bullish_score, "#.#") + "/" + str.tostring(max_score, "#.#") + "]\n" : "\n") + (trend1 == 1 ? "âœ“ " + tf1 + " [" + str.tostring(weight1, "#.#") + "]\n" : "") + (trend2 == 1 ? "âœ“ " + tf2 + " [" + str.tostring(weight2, "#.#") + "]\n" : "") + (trend3 == 1 ? "âœ“ " + tf3 + " [" + str.tostring(weight3, "#.#") + "]\n" : "") + (trend4 == 1 ? "âœ“ " + tf4 + " [" + str.tostring(weight4, "#.#") + "]" : "")
    label.new(bar_index, low, signal_text, style=label.style_label_up, color=color.new(color.green, 80), textcolor=color.white, size=size.small)

if sell_signal_new
    signal_text = "å–å‡ºä¿¡å·" + (show_score ? " [" + str.tostring(bearish_score, "#.#") + "/" + str.tostring(max_score, "#.#") + "]\n" : "\n") + (trend1 == -1 ? "âœ“ " + tf1 + " [" + str.tostring(weight1, "#.#") + "]\n" : "") + (trend2 == -1 ? "âœ“ " + tf2 + " [" + str.tostring(weight2, "#.#") + "]\n" : "") + (trend3 == -1 ? "âœ“ " + tf3 + " [" + str.tostring(weight3, "#.#") + "]\n" : "") + (trend4 == -1 ? "âœ“ " + tf4 + " [" + str.tostring(weight4, "#.#") + "]" : "")
    label.new(bar_index, high, signal_text, style=label.style_label_down, color=color.new(color.red, 80), textcolor=color.white, size=size.small)

// ============================================
// çŠ¶æ€è¡¨æ ¼
// ============================================
if show_mtf_status and barstate.islast
    var table status_table = table.new(position.top_right, 4, 6, border_width=1, border_color=color.gray)
    
    if barstate.isfirst
        table.cell(status_table, 0, 0, "å‘¨æœŸ", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 1, 0, "è¶‹åŠ¿", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 2, 0, "æƒé‡", bgcolor=color.new(color.gray, 70), text_color=color.white)
        table.cell(status_table, 3, 0, "å¾—åˆ†", bgcolor=color.new(color.gray, 70), text_color=color.white)
    
    table.cell(status_table, 0, 1, tf1, text_color=color.white)
    table.cell(status_table, 1, 1, trend1 == 1 ? "â†‘" : trend1 == -1 ? "â†“" : "â€”", bgcolor=trend1 == 1 ? color.new(color.green, 70) : trend1 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 1, str.tostring(weight1, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 1, str.tostring(score1, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 2, tf2, text_color=color.white)
    table.cell(status_table, 1, 2, trend2 == 1 ? "â†‘" : trend2 == -1 ? "â†“" : "â€”", bgcolor=trend2 == 1 ? color.new(color.green, 70) : trend2 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 2, str.tostring(weight2, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 2, str.tostring(score2, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 3, tf3, text_color=color.white)
    table.cell(status_table, 1, 3, trend3 == 1 ? "â†‘" : trend3 == -1 ? "â†“" : "â€”", bgcolor=trend3 == 1 ? color.new(color.green, 70) : trend3 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 3, str.tostring(weight3, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 3, str.tostring(score3, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 4, tf4, text_color=color.white)
    table.cell(status_table, 1, 4, trend4 == 1 ? "â†‘" : trend4 == -1 ? "â†“" : "â€”", bgcolor=trend4 == 1 ? color.new(color.green, 70) : trend4 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 4, str.tostring(weight4, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 4, str.tostring(score4, "#.#"), text_color=color.white)
    
    table.cell(status_table, 0, 5, "æ€»åˆ†", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 1, 5, bullish_score > bearish_score ? "â†‘" : bearish_score > bullish_score ? "â†“" : "â€”", bgcolor=bullish_score > bearish_score ? color.new(color.green, 70) : bearish_score > bullish_score ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
    table.cell(status_table, 2, 5, str.tostring(max_score, "#.#"), text_color=color.white)
    table.cell(status_table, 3, 5, str.tostring(math.max(bullish_score, bearish_score), "#.#") + "/" + str.tostring(signal_threshold, "#.#"), text_color=bullish_score >= signal_threshold or bearish_score >= signal_threshold ? color.yellow : color.white)

alertcondition(buy_signal_new, "ä¹°å…¥ä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤ä¹°å…¥ä¿¡å·")
alertcondition(sell_signal_new, "å–å‡ºä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤å–å‡ºä¿¡å·")

bgcolor(buy_signal ? color.new(color.green, 95) : sell_signal ? color.new(color.red, 95) : na)
