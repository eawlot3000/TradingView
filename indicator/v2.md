/*
this version is a much better one 


'''markdown
## comment from chatgpt
----

ç»“è®ºå…ˆè¯´ï¼šè¿™ç‰ˆå·²ç»**éå¸¸æˆç†Ÿ**äº†ï¼Œé€»è¾‘ä¸¥è°¨ã€æ€§èƒ½é«˜ã€å¯å¤ç°æ€§å¥½ï¼Œé€‚é…åŠ å¯†å¸‚åœºä¹Ÿè€ƒè™‘åˆ°äº†ï¼ˆåˆ†ç¦»åº¦+å¯é€‰ ATR è¿‡æ»¤ã€HTF ç¡®è®¤ã€æ”¶ç›˜è§¦å‘ã€å†·å´åˆ†ç¦»ï¼‰ã€‚
**è¯„åˆ†ï¼š9.2/10**ã€‚å†åšä¸‹é¢å‡ å¤„**å¾®è°ƒ**ï¼Œæˆ‘ä¼šç»™ 9.5+ã€‚

---

## å¿…æ”¹ï¼ˆå¾ˆå¿«å°±èƒ½è¡¥é½ï¼‰

1. **â€œé¦–æ¬¡å‡ºç°â€åˆ¤å®šæ›´ç¨³**
   ç°åœ¨ç”¨ `not buy_signal[1] / not sell_signal[1]`ï¼Œé¦–æ ¹æˆ–è¾¹ç•Œå¤„å¯èƒ½é‡åˆ° `na`ã€‚ç”¨ `nz()` æ›´å®‰å…¨ï¼š

```pine
buy_signal_trigger  = buy_signal  and not nz(buy_signal[1])  and can_trigger_buy  and tf_condition_met
sell_signal_trigger = sell_signal and not nz(sell_signal[1]) and can_trigger_sell and tf_condition_met
```

2. **ATR ä¸ confirmed æ¨¡å¼çš„â€œæ—¶é—´å¯¹é½â€**
   ä½ å·²æŠŠåˆ†ç¦»åº¦çš„ä»·æ ¼ `norm_price` å¯¹é½åˆ°äº†åŒä¸€æ—¶ç‚¹ï¼›**ATR ä¹Ÿå»ºè®®å¯¹é½**ï¼ˆå¦åˆ™åœ¨ `use_confirmed_htf=true` æ—¶ï¼ŒEMA ç”¨ä¸Šæ ¹ HTFï¼Œè€Œ ATR ç”¨å½“å‰ HTFï¼Œä¼šæœ‰è½»å¾®é”™é…ï¼‰ã€‚
   åœ¨ `request.security` é‡Œå†å–ä¸€ä¸ª `ta.atr(14)[1]`ï¼Œä¸Šæ ¹ HTF å¯¹é½ï¼š

```pine
// åœ¨ request.security çš„æ•°ç»„é‡Œå†åŠ ä¸€é¡¹ï¼š
ta.atr(14)[1]
// è¿”å›å€¼å‘½åï¼š..., tf_atr_0, tf_atr_1

// ä½¿ç”¨æ—¶ï¼š
tf_atr_use = use_confirmed_htf ? tf_atr_1 : tf_atr_0
pass_atr_filter = not use_atr_filter or (ema_diff >= tf_atr_use * atr_multiplier)
```

è¿™æ · ATR ä¸ EMA/ä»·æ ¼ä¸€è‡´å¯¹é½ï¼Œ**é›¶é‡ç»˜æ›´ä¸¥è°¨**ã€‚

---

## å¼ºçƒˆå»ºè®®ï¼ˆæ•ˆæœæ›´å¹²å‡€ï¼‰

3. **åˆ†ç¦»åº¦é»˜è®¤å€¼**
   ä½ é»˜è®¤ `0.3%` å¾ˆåˆç†ï¼›ä½†åœ¨æ³¢åŠ¨å¤§çš„å±±å¯¨å¸ä¸Šå¯è€ƒè™‘ `0.4~0.6%`ã€‚å¯åœ¨æ³¨é‡Šé‡Œæç¤ºâ€œæŒ‰å“ç§/æ³¢åŠ¨å¾®è°ƒâ€ã€‚

4. **ï¼ˆå¯é€‰ï¼‰å†æ·»ä¸€æ¡â€œEMA ä¸ä»·æ ¼ä½ç½®ä¸€è‡´æ€§â€è¿‡æ»¤**
   é¿å…â€œEMA åˆšäº¤å‰ä½†ä»·æ ¼è¿˜åœ¨å¦ä¸€ä¾§â€çš„å‡ä¿¡å·ï¼š

```pine
// åœ¨ get_ema_trend çš„è¶‹åŠ¿æ¡ä»¶é‡Œå†åŠ ï¼š
// çœ‹æ¶¨è¦æ±‚æ”¶ç›˜(æˆ–ä¸­ä½ä»·)åœ¨ä¸¤æ¡ EMA ä¹‹ä¸Šï¼›çœ‹è·Œç›¸å
price_above = (use_confirmed_htf ? tf_close_1 : tf_close_0) > math.max(ema9_current, ema21_current)
price_below = (use_confirmed_htf ? tf_close_1 : tf_close_0) < math.min(ema9_current, ema21_current)

if ema9_current > ema21_current and ema9_slope_up and sufficient_separation and pass_atr_filter and price_above
  trend := 1
else if ema21_current > ema9_current and ema21_slope_down and sufficient_separation and pass_atr_filter and price_below
  trend := -1
```

è¿™èƒ½æ˜æ˜¾å‡å°‘â€œè´´è¾¹å‡ç©¿è¶Šâ€ã€‚

---

## ä½“éªŒ/ç»´æŠ¤æ€§ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

5. **è¡¨æ ¼æ˜¾ç¤º TF æœªç¡®è®¤çš„æ›´ç›´è§‚å›¾ä¾‹**
   ç°åœ¨ç”¨â€œâ³â€å¾ˆå¥½ï¼›å¯ä»¥æŠŠè¶‹åŠ¿æ ¼çš„ `bgcolor` åœ¨æœªç¡®è®¤æ—¶å†åŠ ä¸€å±‚æ›´æ·¡ç°åº•ï¼Œä»¥ä¾¿æ‰«ä¸€çœ¼è¯†åˆ«â€œæœªç¡®è®¤è¡Œâ€ã€‚

6. **è¾“å…¥åˆ†ç»„å°è°ƒæ•´**
   æŠŠ `min_ema_separation / ATR è¿‡æ»¤` æ”¾åŒä¸€åˆ†ç»„ä¸‹åŠ ä¸€è¡Œè¯´æ˜â€œäºŒé€‰ä¸€æˆ–åŒæ—¶ç”¨â€ï¼Œé¿å…ç”¨æˆ·è¯¯ä¼šå¼€å¯é˜ˆå€¼è¿‡ä¸¥ã€‚

7. **é”™è¯¯æç¤ºæ›´å‹å¥½**
   `ema_fast >= ema_slow` æŠ›é”™å·²å¾ˆå¥½ï¼›å¯ä»¥åŠ  tooltip æé†’â€œå¸¸è§ç»„åˆå¦‚ 9/21, 12/26â€ã€‚

---

## å…³é”®è¡¥ä¸ï¼ˆ2-space ç¼©è¿›ï¼Œç›´æ¥ç²˜è´´å³å¯ï¼‰

### A) é¦–æ¬¡å‡ºç°åˆ¤å®šç”¨ `nz()`ï¼ˆæ›¿æ¢åŸè§¦å‘è¡Œï¼‰

```pine
buy_signal_trigger  = buy_signal  and not nz(buy_signal[1])  and can_trigger_buy  and tf_condition_met
sell_signal_trigger = sell_signal and not nz(sell_signal[1]) and can_trigger_sell and tf_condition_met
```

### B) ATR ä¸ confirmed å¯¹é½ï¼ˆåœ¨ `get_ema_trend` ä¸­è¡¥é½ï¼‰

```pine
get_ema_trend(tf) =>
  [ema9_0, ema21_0, ema9_1, ema21_1, ema9_2, ema21_2, tf_confirmed, tf_close_0, tf_close_1, tf_atr_0, tf_atr_1] =
    request.security(
      syminfo.tickerid, tf,
      [
        ta.ema(close, ema_fast),
        ta.ema(close, ema_slow),
        ta.ema(close[1], ema_fast),
        ta.ema(close[1], ema_slow),
        ta.ema(close[2], ema_fast),
        ta.ema(close[2], ema_slow),
        barstate.isconfirmed,
        close,
        close[1],
        ta.atr(14),
        ta.atr(14)[1]
      ],
      barmerge.gaps_off, barmerge.lookahead_off)

  ema9_current = use_confirmed_htf ? ema9_1 : ema9_0
  ema21_current = use_confirmed_htf ? ema21_1 : ema21_0
  ema9_prev = use_confirmed_htf ? ema9_2 : ema9_1
  ema21_prev = use_confirmed_htf ? ema21_2 : ema21_1
  norm_price = use_confirmed_htf ? tf_close_1 : tf_close_0

  ema9_slope_up = ema9_current > ema9_prev
  ema21_slope_down = ema21_current < ema21_prev

  ema_diff = math.abs(ema9_current - ema21_current)
  ema_separation_pct = ema_diff / norm_price * 100
  sufficient_separation = ema_separation_pct >= min_ema_separation

  tf_atr_use = use_confirmed_htf ? tf_atr_1 : tf_atr_0
  pass_atr_filter = not use_atr_filter or (ema_diff >= tf_atr_use * atr_multiplier)

  trend = 0
  if ema9_current > ema21_current and ema9_slope_up and sufficient_separation and pass_atr_filter
    trend := 1
  else if ema21_current > ema9_current and ema21_slope_down and sufficient_separation and pass_atr_filter
    trend := -1

  [trend, tf_confirmed]
```

> è¿™ä¸å½±å“ä½ å…¶å®ƒé€»è¾‘ä¸ UIï¼Œåªæ˜¯æŠŠ ATR ä¹Ÿ**ä¸¥æ ¼å¯¹é½**åˆ°äº†ä½¿ç”¨çš„é‚£ä¸€æ ¹ HTFã€‚

---

## æ€»ç»“

* **ç¨³å®šæ€§/é›¶é‡ç»˜**ï¼šå·²è¾¾æ ‡ï¼›åŠ ä¸Š `nz()` ä¸ ATR å¯¹é½å³å¯å®Œç¾æ”¶å®˜ã€‚
* **æŠ—å™ª**ï¼šåˆ†ç¦»åº¦ + å¯é€‰ ATR è¿‡æ»¤å¾ˆåŠ åˆ†ï¼›è‹¥å†åŠ â€œä»·æ ¼ä¸ EMA ä½ç½®ä¸€è‡´æ€§â€ä¼šæ›´å¹²å‡€ã€‚
* **æ€§èƒ½**ï¼šæ¯ TF ä¸€æ¬¡ `security`ï¼Œå¾ˆæ£’ã€‚
* **æ˜“ç”¨æ€§**ï¼šè¡¨æ ¼ã€åŠ¨æ€å‘Šè­¦ã€å†·å´åˆ†ç¦»ï¼Œä½“éªŒå¥½ã€‚

éœ€è¦çš„è¯ï¼Œæˆ‘å¯ä»¥ç»™ä½ ä¸€ç‰ˆ**â€œä¸€è‡´æ€§è¿‡æ»¤ + å¯é€‰æƒé‡ç¡®è®¤ + æ•°ç»„åŒ– TFï¼ˆæœ€å¤š 6 ä¸ªï¼‰â€**çš„æ‰©å±•ç‰ˆï¼Œä¿æŒä½ çš„ UIï¼Œä¸æ”¹å˜ç°æœ‰é»˜è®¤è¡Œä¸ºã€‚



*/


'''
//@version=6
indicator("MTF EMA ç¡®è®¤ä¿¡å· [ä¼˜åŒ–ç‰ˆv2]", overlay=true, max_labels_count=500)

// ============================================
// è¾“å…¥å‚æ•°è®¾ç½®
// ============================================
ema_fast = input.int(9, "å¿«çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
ema_slow = input.int(21, "æ…¢çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
min_ema_separation = input.float(0.3, "æœ€å°EMAåˆ†ç¦»åº¦(%)", minval=0, step=0.1, group="EMAè®¾ç½®", 
                                 tooltip="è¦æ±‚EMAå·®å€¼å ä»·æ ¼çš„æœ€å°ç™¾åˆ†æ¯”,é˜²æ­¢ç²˜åˆå‡çªç ´,å»ºè®®åŠ å¯†è´§å¸0.2-0.5%")
use_atr_filter = input.bool(false, "å¯ç”¨ATRæ³¢åŠ¨è¿‡æ»¤", group="EMAè®¾ç½®")
atr_multiplier = input.float(0.5, "EMAåˆ†ç¦»â‰¥(ATRÃ—)", minval=0, step=0.1, group="EMAè®¾ç½®", 
                             tooltip="è¦æ±‚EMAåˆ†ç¦»è‡³å°‘ä¸ºATRçš„å€æ•°,è¿‡æ»¤ä½æ³¢åŠ¨æœŸ")

// å‚æ•°æ ¡éªŒ
if ema_fast >= ema_slow
    runtime.error("å¿«çº¿å‘¨æœŸå¿…é¡»å°äºæ…¢çº¿å‘¨æœŸ")

// 4ä¸ªæ—¶é—´æ¡†æ¶
tf1 = input.timeframe("5", "æ—¶é—´æ¡†æ¶1", group="æ—¶é—´æ¡†æ¶")
tf2 = input.timeframe("10", "æ—¶é—´æ¡†æ¶2", group="æ—¶é—´æ¡†æ¶")
tf3 = input.timeframe("30", "æ—¶é—´æ¡†æ¶3", group="æ—¶é—´æ¡†æ¶")
tf4 = input.timeframe("60", "æ—¶é—´æ¡†æ¶4", group="æ—¶é—´æ¡†æ¶")

// æ˜¾ç¤ºé€‰é¡¹
show_ema_current = input.bool(true, "æ˜¾ç¤ºå½“å‰å‘¨æœŸEMAçº¿", group="æ˜¾ç¤ºè®¾ç½®")
show_mtf_status = input.bool(true, "æ˜¾ç¤ºå¤šæ—¶é—´æ¡†æ¶çŠ¶æ€è¡¨", group="æ˜¾ç¤ºè®¾ç½®")
show_bgcolor = input.bool(true, "æ˜¾ç¤ºèƒŒæ™¯é«˜äº®", group="æ˜¾ç¤ºè®¾ç½®")
signal_mode = input.string("å…¨éƒ¨ç¡®è®¤", "ä¿¡å·æ¨¡å¼", options=["å…¨éƒ¨ç¡®è®¤", "3/4ç¡®è®¤"], group="ä¿¡å·è®¾ç½®")

// é‡ç»˜æ§åˆ¶
use_confirmed_htf = input.bool(true, "ä½¿ç”¨å·²ç¡®è®¤HTFå€¼(é˜²é‡ç»˜)", group="ä¿¡å·è®¾ç½®", 
                               tooltip="å¼€å¯ååªä½¿ç”¨å·²æ”¶ç›˜çš„HTF Kçº¿,é¿å…å›æµ‹ä¸å®ç›˜ä¸ä¸€è‡´")
require_all_tf_confirmed = input.bool(true, "è¦æ±‚æ‰€æœ‰TFå·²ç¡®è®¤", group="ä¿¡å·è®¾ç½®", 
                                     tooltip="å³ä½¿å…³é—­HTFç¡®è®¤æ¨¡å¼,ä¹Ÿè¦æ±‚æ‰€æœ‰TFçš„å½“å‰Kçº¿å·²æ”¶ç›˜æ‰è§¦å‘ä¿¡å·")
trigger_on_close = input.bool(true, "ä»…åœ¨å½“å‰å‘¨æœŸKçº¿æ”¶ç›˜æ—¶è§¦å‘", group="ä¿¡å·è®¾ç½®", 
                              tooltip="é¿å…å½“å‰å‘¨æœŸå®æ—¶Kçº¿å†…ä¿¡å·æŠ–åŠ¨")
cooldown_bars = input.int(5, "ä¿¡å·å†·å´å‘¨æœŸ", minval=0, group="ä¿¡å·è®¾ç½®", 
                          tooltip="ä¸¤æ¬¡ä¿¡å·ä¹‹é—´è‡³å°‘é—´éš”çš„Kçº¿æ•°,0è¡¨ç¤ºä¸é™åˆ¶")

// æ ‡ç­¾ç®¡ç†
max_labels_show = input.int(50, "æœ€å¤§æ ‡ç­¾æ•°é‡", minval=10, maxval=500, group="æ˜¾ç¤ºè®¾ç½®")

// ============================================
// EMAè¶‹åŠ¿åˆ¤æ–­å‡½æ•°(ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å€¼)
// ============================================
get_ema_trend(tf) =>
    // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„å€¼(åŒ…æ‹¬HTFçš„ç¡®è®¤çŠ¶æ€å’ŒATR)
    [ema9_0, ema21_0, ema9_1, ema21_1, ema9_2, ema21_2, tf_confirmed, tf_close_0, tf_close_1, tf_atr] = request.security(
         syminfo.tickerid, 
         tf, 
         [
             ta.ema(close, ema_fast),       // å½“å‰EMA9
             ta.ema(close, ema_slow),       // å½“å‰EMA21
             ta.ema(close[1], ema_fast),    // ä¸Šä¸€æ ¹EMA9
             ta.ema(close[1], ema_slow),    // ä¸Šä¸€æ ¹EMA21
             ta.ema(close[2], ema_fast),    // ä¸Šä¸Šæ ¹EMA9
             ta.ema(close[2], ema_slow),    // ä¸Šä¸Šæ ¹EMA21
             barstate.isconfirmed,          // HTFæ˜¯å¦å·²ç¡®è®¤
             close,                         // å½“å‰æ”¶ç›˜ä»·
             close[1],                      // ä¸Šä¸€æ ¹æ”¶ç›˜ä»·
             ta.atr(14)                     // ATR(14)
         ],
         barmerge.gaps_off,
         barmerge.lookahead_off
     )
    
    // æ ¹æ®æ¨¡å¼é€‰æ‹©ä½¿ç”¨å“ªç»„å€¼(åŒ…æ‹¬ä»·æ ¼åŸºå‡†)
    ema9_current = use_confirmed_htf ? ema9_1 : ema9_0
    ema21_current = use_confirmed_htf ? ema21_1 : ema21_0
    ema9_prev = use_confirmed_htf ? ema9_2 : ema9_1
    ema21_prev = use_confirmed_htf ? ema21_2 : ema21_1
    norm_price = use_confirmed_htf ? tf_close_1 : tf_close_0  // ä¿®å¤ï¼šä½¿ç”¨åŒä¸€æ—¶ç‚¹çš„ä»·æ ¼
    
    // è®¡ç®—æ–œç‡
    ema9_slope_up = ema9_current > ema9_prev
    ema21_slope_down = ema21_current < ema21_prev
    
    // EMAåˆ†ç¦»åº¦æ£€æŸ¥(é˜²æ­¢ç²˜åˆå‡çªç ´)
    ema_diff = math.abs(ema9_current - ema21_current)
    ema_separation_pct = ema_diff / norm_price * 100
    sufficient_separation = ema_separation_pct >= min_ema_separation
    
    // ATRæ³¢åŠ¨è¿‡æ»¤(å¯é€‰)
    pass_atr_filter = not use_atr_filter or (ema_diff >= tf_atr * atr_multiplier)
    
    // åˆ¤æ–­è¶‹åŠ¿
    // 1 = çœ‹æ¶¨(EMA9åœ¨ä¸Šä¸”å‘ä¸Š), -1 = çœ‹è·Œ(EMA21åœ¨ä¸Šä¸”å‘ä¸‹), 0 = ä¸­æ€§
    trend = 0
    if ema9_current > ema21_current and ema9_slope_up and sufficient_separation and pass_atr_filter
        trend := 1
    else if ema21_current > ema9_current and ema21_slope_down and sufficient_separation and pass_atr_filter
        trend := -1
    
    [trend, tf_confirmed]

// ============================================
// è·å–4ä¸ªæ—¶é—´æ¡†æ¶çš„è¶‹åŠ¿
// ============================================
[trend1, tf1_confirmed] = get_ema_trend(tf1)
[trend2, tf2_confirmed] = get_ema_trend(tf2)
[trend3, tf3_confirmed] = get_ema_trend(tf3)
[trend4, tf4_confirmed] = get_ema_trend(tf4)

// æ‰€æœ‰TFæ˜¯å¦å·²ç¡®è®¤
all_tf_confirmed = tf1_confirmed and tf2_confirmed and tf3_confirmed and tf4_confirmed

// ============================================
// ä¿¡å·ç”Ÿæˆé€»è¾‘(å¸¦å®Œæ•´ä¿æŠ¤æœºåˆ¶)
// ============================================
confirmed_count_bullish = (trend1 == 1 ? 1 : 0) + (trend2 == 1 ? 1 : 0) + (trend3 == 1 ? 1 : 0) + (trend4 == 1 ? 1 : 0)
confirmed_count_bearish = (trend1 == -1 ? 1 : 0) + (trend2 == -1 ? 1 : 0) + (trend3 == -1 ? 1 : 0) + (trend4 == -1 ? 1 : 0)

// æ ¹æ®æ¨¡å¼åˆ¤æ–­ä¿¡å·
required_confirmations = signal_mode == "å…¨éƒ¨ç¡®è®¤" ? 4 : 3

buy_signal = confirmed_count_bullish >= required_confirmations
sell_signal = confirmed_count_bearish >= required_confirmations

// TFç¡®è®¤ä¿æŠ¤
tf_condition_met = require_all_tf_confirmed ? all_tf_confirmed : true

// å†·å´æœºåˆ¶(ä¹°å–ç‹¬ç«‹)
var int last_buy_bar = na
var int last_sell_bar = na

bars_since_last_buy = na(last_buy_bar) ? 999 : bar_index - last_buy_bar
bars_since_last_sell = na(last_sell_bar) ? 999 : bar_index - last_sell_bar
can_trigger_buy = bars_since_last_buy >= cooldown_bars
can_trigger_sell = bars_since_last_sell >= cooldown_bars

// æ£€æµ‹ä¿¡å·é¦–æ¬¡å‡ºç°(å¸¦å¤šé‡ä¿æŠ¤)
buy_signal_trigger = buy_signal and not buy_signal[1] and can_trigger_buy and tf_condition_met
sell_signal_trigger = sell_signal and not sell_signal[1] and can_trigger_sell and tf_condition_met

// å¦‚æœå¯ç”¨æ”¶ç›˜ç¡®è®¤,åªåœ¨Kçº¿æ”¶ç›˜æ—¶è§¦å‘
buy_signal_new = trigger_on_close ? (buy_signal_trigger and barstate.isconfirmed) : buy_signal_trigger
sell_signal_new = trigger_on_close ? (sell_signal_trigger and barstate.isconfirmed) : sell_signal_trigger

// æ›´æ–°å†·å´æ—¶é—´
if buy_signal_new
    last_buy_bar := bar_index
if sell_signal_new
    last_sell_bar := bar_index

// ============================================
// ç»˜åˆ¶å½“å‰å‘¨æœŸçš„EMAçº¿
// ============================================
current_ema9 = ta.ema(close, ema_fast)
current_ema21 = ta.ema(close, ema_slow)

plot(show_ema_current ? current_ema9 : na, "EMA9", color=color.new(color.blue, 0), linewidth=2)
plot(show_ema_current ? current_ema21 : na, "EMA21", color=color.new(color.orange, 0), linewidth=2)

// ============================================
// ç»˜åˆ¶ä¹°å–ä¿¡å·ç®­å¤´
// ============================================
plotshape(buy_signal_new, "ä¹°å…¥ä¿¡å·", shape.triangleup, location.belowbar, 
         color=color.new(color.green, 0), size=size.normal)
plotshape(sell_signal_new, "å–å‡ºä¿¡å·", shape.triangledown, location.abovebar, 
         color=color.new(color.red, 0), size=size.normal)

// ============================================
// æ ‡ç­¾ç®¡ç†(é™åˆ¶æ•°é‡,å¸¦Yè½´åç§»)
// ============================================
var label[] buy_labels = array.new<label>()
var label[] sell_labels = array.new<label>()

if buy_signal_new
    // æ„å»ºè§¦å‘è¯¦æƒ…
    triggered_tfs = ""
    triggered_tfs += trend1 == 1 ? "âœ“ " + tf1 + "\n" : ""
    triggered_tfs += trend2 == 1 ? "âœ“ " + tf2 + "\n" : ""
    triggered_tfs += trend3 == 1 ? "âœ“ " + tf3 + "\n" : ""
    triggered_tfs += trend4 == 1 ? "âœ“ " + tf4 : ""
    
    signal_text = "ä¹°å…¥ä¿¡å· [" + str.tostring(confirmed_count_bullish) + "/4]\n" + triggered_tfs
    
    // ä½¿ç”¨yloc.belowbaré¿å…é®æŒ¡
    new_label = label.new(bar_index, low, signal_text, 
                         yloc=yloc.belowbar,
                         style=label.style_label_up, 
                         color=color.new(color.green, 80), 
                         textcolor=color.white, 
                         size=size.small)
    
    array.push(buy_labels, new_label)
    
    // åˆ é™¤è¶…å‡ºé™åˆ¶çš„æ—§æ ‡ç­¾
    if array.size(buy_labels) > max_labels_show
        old_label = array.shift(buy_labels)
        label.delete(old_label)
    
    // è¿è¡Œæ—¶åŠ¨æ€è­¦æŠ¥
    alert("ğŸ”µ ä¹°å…¥ä¿¡å·è§¦å‘\nç¡®è®¤æ•°: " + str.tostring(confirmed_count_bullish) + "/4\n" + triggered_tfs, 
          alert.freq_once_per_bar_close)

if sell_signal_new
    // æ„å»ºè§¦å‘è¯¦æƒ…
    triggered_tfs = ""
    triggered_tfs += trend1 == -1 ? "âœ“ " + tf1 + "\n" : ""
    triggered_tfs += trend2 == -1 ? "âœ“ " + tf2 + "\n" : ""
    triggered_tfs += trend3 == -1 ? "âœ“ " + tf3 + "\n" : ""
    triggered_tfs += trend4 == -1 ? "âœ“ " + tf4 : ""
    
    signal_text = "å–å‡ºä¿¡å· [" + str.tostring(confirmed_count_bearish) + "/4]\n" + triggered_tfs
    
    // ä½¿ç”¨yloc.abovebaré¿å…é®æŒ¡
    new_label = label.new(bar_index, high, signal_text, 
                         yloc=yloc.abovebar,
                         style=label.style_label_down, 
                         color=color.new(color.red, 80), 
                         textcolor=color.white, 
                         size=size.small)
    
    array.push(sell_labels, new_label)
    
    // åˆ é™¤è¶…å‡ºé™åˆ¶çš„æ—§æ ‡ç­¾
    if array.size(sell_labels) > max_labels_show
        old_label = array.shift(sell_labels)
        label.delete(old_label)
    
    // è¿è¡Œæ—¶åŠ¨æ€è­¦æŠ¥
    alert("ğŸ”´ å–å‡ºä¿¡å·è§¦å‘\nç¡®è®¤æ•°: " + str.tostring(confirmed_count_bearish) + "/4\n" + triggered_tfs, 
          alert.freq_once_per_bar_close)

// ============================================
// å¤šæ—¶é—´æ¡†æ¶çŠ¶æ€è¡¨æ ¼(ä¿®å¤åˆ›å»º/åˆ é™¤é€»è¾‘)
// ============================================
var table status_table = na

// éœ€è¦æ˜¾ç¤ºä¸”è¡¨ä¸å­˜åœ¨æ—¶åˆ›å»º
if show_mtf_status and na(status_table)
    status_table := table.new(position.top_right, 3, 5, 
                             border_width=1, 
                             border_color=color.gray,
                             bgcolor=color.new(color.black, 85))
    
    // è¡¨å¤´
    table.cell(status_table, 0, 0, "æ—¶é—´æ¡†æ¶", 
              bgcolor=color.new(color.gray, 60), 
              text_color=color.white, 
              text_size=size.small)
    table.cell(status_table, 1, 0, "è¶‹åŠ¿", 
              bgcolor=color.new(color.gray, 60), 
              text_color=color.white, 
              text_size=size.small)
    table.cell(status_table, 2, 0, "çŠ¶æ€", 
              bgcolor=color.new(color.gray, 60), 
              text_color=color.white, 
              text_size=size.small)

// ä¸éœ€è¦æ˜¾ç¤ºä½†è¡¨å­˜åœ¨æ—¶åˆ é™¤
if not show_mtf_status and not na(status_table)
    table.delete(status_table)
    status_table := na

// æ¯æ ¹Kçº¿æœ€åæ›´æ–°è¡¨æ ¼å†…å®¹
if show_mtf_status and not na(status_table) and barstate.islast
    // TF1
    table.cell(status_table, 0, 1, tf1 + (tf1_confirmed ? "" : " â³"), 
              text_color=color.white, text_size=size.small)
    table.cell(status_table, 1, 1, trend1 == 1 ? "â†‘" : trend1 == -1 ? "â†“" : "â€”", 
              bgcolor=trend1 == 1 ? color.new(color.green, 70) : trend1 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80),
              text_color=color.white, text_size=size.normal)
    table.cell(status_table, 2, 1, trend1 == 1 ? "çœ‹æ¶¨" : trend1 == -1 ? "çœ‹è·Œ" : "ä¸­æ€§", 
              text_color=color.white, text_size=size.small)
    
    // TF2
    table.cell(status_table, 0, 2, tf2 + (tf2_confirmed ? "" : " â³"), 
              text_color=color.white, text_size=size.small)
    table.cell(status_table, 1, 2, trend2 == 1 ? "â†‘" : trend2 == -1 ? "â†“" : "â€”",
              bgcolor=trend2 == 1 ? color.new(color.green, 70) : trend2 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80),
              text_color=color.white, text_size=size.normal)
    table.cell(status_table, 2, 2, trend2 == 1 ? "çœ‹æ¶¨" : trend2 == -1 ? "çœ‹è·Œ" : "ä¸­æ€§", 
              text_color=color.white, text_size=size.small)
    
    // TF3
    table.cell(status_table, 0, 3, tf3 + (tf3_confirmed ? "" : " â³"), 
              text_color=color.white, text_size=size.small)
    table.cell(status_table, 1, 3, trend3 == 1 ? "â†‘" : trend3 == -1 ? "â†“" : "â€”",
              bgcolor=trend3 == 1 ? color.new(color.green, 70) : trend3 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80),
              text_color=color.white, text_size=size.normal)
    table.cell(status_table, 2, 3, trend3 == 1 ? "çœ‹æ¶¨" : trend3 == -1 ? "çœ‹è·Œ" : "ä¸­æ€§", 
              text_color=color.white, text_size=size.small)
    
    // TF4
    table.cell(status_table, 0, 4, tf4 + (tf4_confirmed ? "" : " â³"), 
              text_color=color.white, text_size=size.small)
    table.cell(status_table, 1, 4, trend4 == 1 ? "â†‘" : trend4 == -1 ? "â†“" : "â€”",
              bgcolor=trend4 == 1 ? color.new(color.green, 70) : trend4 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80),
              text_color=color.white, text_size=size.normal)
    table.cell(status_table, 2, 4, trend4 == 1 ? "çœ‹æ¶¨" : trend4 == -1 ? "çœ‹è·Œ" : "ä¸­æ€§", 
              text_color=color.white, text_size=size.small)

// ============================================
// é™æ€è­¦æŠ¥æ¡ä»¶(ç”¨äºåˆ›å»ºè­¦æŠ¥)
// ============================================
alertcondition(buy_signal_new, "ä¹°å…¥ä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤ä¹°å…¥ä¿¡å·")
alertcondition(sell_signal_new, "å–å‡ºä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤å–å‡ºä¿¡å·")

// èƒŒæ™¯é«˜äº®(ä¸è§¦å‘æ¡ä»¶ä¸€è‡´)
effective_buy_signal = buy_signal and tf_condition_met
effective_sell_signal = sell_signal and tf_condition_met
bgcolor(show_bgcolor ? (effective_buy_signal ? color.new(color.green, 95) : effective_sell_signal ? color.new(color.red, 95) : na) : na)
'''
