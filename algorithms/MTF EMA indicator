//@version=5
indicator("MTF EMA ç¡®è®¤ä¿¡å· [Pro Max]", overlay=true, max_labels_count=500)

// ============================================
// ğŸ“Œ EMAåŸºç¡€å‚æ•°
// ============================================
ema_fast = input.int(9, "å¿«çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
ema_slow = input.int(21, "æ…¢çº¿EMAå‘¨æœŸ", minval=1, group="EMAè®¾ç½®")
slope_length = input.int(1, "æ–œç‡è®¡ç®—å‘¨æœŸ", minval=1, group="EMAè®¾ç½®")

// ============================================
// ğŸ“Œ å¤šæ—¶é—´æ¡†æ¶åŠæƒé‡
// ============================================
tf1 = input.timeframe("5", "æ—¶é—´æ¡†æ¶1", group="æ—¶é—´æ¡†æ¶")
weight1 = input.float(1.0, "æƒé‡1", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf2 = input.timeframe("10", "æ—¶é—´æ¡†æ¶2", group="æ—¶é—´æ¡†æ¶")
weight2 = input.float(1.5, "æƒé‡2", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf3 = input.timeframe("30", "æ—¶é—´æ¡†æ¶3", group="æ—¶é—´æ¡†æ¶")
weight3 = input.float(2.0, "æƒé‡3", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

tf4 = input.timeframe("60", "æ—¶é—´æ¡†æ¶4", group="æ—¶é—´æ¡†æ¶")
weight4 = input.float(3.0, "æƒé‡4", minval=0.1, maxval=5.0, step=0.1, group="æ—¶é—´æ¡†æ¶")

// ============================================
// ğŸ“Œ ä¿¡å·è®¾ç½®
// ============================================
signal_threshold = input.float(5.0, "ä¿¡å·é˜ˆå€¼åˆ†æ•°", minval=0, step=0.5, group="ä¿¡å·è®¾ç½®")
cooldown_bars = input.int(5, "å†·å´æœŸ(Kçº¿æ•°)", minval=0, group="ä¿¡å·è®¾ç½®")
use_confirmed = input.bool(true, "é˜²é‡ç»˜æ¨¡å¼", group="ä¿¡å·è®¾ç½®")

// ============================================
// ğŸ“Œ é”šå®šTFè®¾ç½®ï¼ˆå‡çº§6ï¼‰
// ============================================
anchor_tf = input.timeframe("60", "é”šå®šæ—¶é—´æ¡†æ¶", group="é”šå®šè®¾ç½®")
gate_mode = input.bool(false, "å¯ç”¨é”šå®šé—¨æ§", group="é”šå®šè®¾ç½®", tooltip="å‹¾é€‰åï¼Œé”šå®šTFå¿…é¡»åŒå‘æ‰èƒ½å‘ä¿¡å·")
sync_on_close = input.bool(false, "ä»…åœ¨é”šTFæ”¶ç›˜æ—¶è§¦å‘", group="é”šå®šè®¾ç½®", tooltip="å‹¾é€‰åï¼Œåªåœ¨é”šå®šTFçš„Kçº¿æ”¶ç›˜æ—¶æ‰å…è®¸ä¿¡å·")

// ============================================
// ğŸ“Œ è¶‹åŠ¿å¼ºåº¦è¿‡æ»¤ï¼ˆå‡çº§2ï¼‰
// ============================================
slope_atr_mult = input.float(0.2, "æ–œç‡æœ€å°å€æ•°(ATRå½’ä¸€)", minval=0.0, step=0.05, group="å¼ºåº¦è¿‡æ»¤", tooltip="EMAæ–œç‡è‡³å°‘è¦è¾¾åˆ°ATRçš„æ­¤å€æ•°")
spread_atr_mult = input.float(0.5, "EMAé—´è·æœ€å°å€æ•°(ATRå½’ä¸€)", minval=0.0, step=0.05, group="å¼ºåº¦è¿‡æ»¤", tooltip="å¿«æ…¢çº¿é—´è·è‡³å°‘è¦è¾¾åˆ°ATRçš„æ­¤å€æ•°")

// ============================================
// ğŸ“Œ æŒä¹…åº¦ä¸ä¸€è‡´æ€§ï¼ˆå‡çº§3ï¼‰
// ============================================
persist_len = input.int(2, "è¶‹åŠ¿æŒä¹…åº¦(åŒå‘Næ ¹)", minval=0, group="æŒä¹…åº¦è¿‡æ»¤", tooltip="è¶‹åŠ¿è‡³å°‘æŒç»­Næ ¹Kçº¿")
win_len = input.int(3, "ä¸€è‡´æ€§çª—å£é•¿åº¦", minval=1, group="æŒä¹…åº¦è¿‡æ»¤")
win_need = input.int(2, "çª—å£å†…è‡³å°‘æ»¡è¶³Kæ ¹", minval=1, group="æŒä¹…åº¦è¿‡æ»¤", tooltip="çª—å£å†…è‡³å°‘Kæ ¹æ»¡è¶³è¶‹åŠ¿æ¡ä»¶")

// ============================================
// ğŸ“Œ ATRæ³¢åŠ¨ç‡è¿‡æ»¤
// ============================================
use_atr_filter = input.bool(false, "å¯ç”¨ATRæ³¢åŠ¨ç‡è¿‡æ»¤", group="å¸‚åœºè¿‡æ»¤")
atr_length = input.int(14, "ATRå‘¨æœŸ", minval=1, group="å¸‚åœºè¿‡æ»¤")
atr_threshold = input.float(0.5, "æœ€ä½ATR%", minval=0, step=0.1, group="å¸‚åœºè¿‡æ»¤")

// ============================================
// ğŸ“Œ CMFèµ„é‡‘æµè¿‡æ»¤
// ============================================
use_cmf_filter = input.bool(false, "å¯ç”¨CMFèµ„é‡‘æµè¿‡æ»¤", group="å¸‚åœºè¿‡æ»¤")
cmf_length = input.int(20, "CMFå‘¨æœŸ", minval=1, group="å¸‚åœºè¿‡æ»¤")
cmf_threshold = input.float(0.0, "CMFé˜ˆå€¼", minval=0.0, maxval=1.0, step=0.05, group="å¸‚åœºè¿‡æ»¤", tooltip="å¤šå•éœ€CMF>é˜ˆå€¼ï¼Œç©ºå•éœ€CMF<-é˜ˆå€¼")

// ============================================
// ğŸ“Œ ç›¸å¯¹å¼ºåº¦è¿‡æ»¤ï¼ˆå‡çº§4ï¼‰
// ============================================
use_rs = input.bool(false, "å¯ç”¨ç›¸å¯¹å¼ºåº¦è¿‡æ»¤", group="åŠ å¯†å¸‚åœºç‰¹åŒ–", tooltip="è¦æ±‚å½“å‰å¸ç§ç›¸å¯¹äºåŸºå‡†èµ°å¼º/èµ°å¼±")
bench_sym = input.symbol("BINANCE:BTCUSDT", "åŸºå‡†ç¬¦å·", group="åŠ å¯†å¸‚åœºç‰¹åŒ–")
rs_len = input.int(50, "RSå‡çº¿é•¿åº¦", minval=1, group="åŠ å¯†å¸‚åœºç‰¹åŒ–")

// ============================================
// ğŸ“Œ é‡èƒ½è¿‡æ»¤ï¼ˆå‡çº§5ï¼‰
// ============================================
use_vol_filter = input.bool(false, "å¯ç”¨é‡èƒ½è¿‡æ»¤", group="åŠ å¯†å¸‚åœºç‰¹åŒ–", tooltip="è¦æ±‚æˆäº¤é‡é«˜äºå‡é‡")
vol_ma_len = input.int(20, "é‡èƒ½å‡çº¿é•¿åº¦", minval=1, group="åŠ å¯†å¸‚åœºç‰¹åŒ–")
vol_mult = input.float(1.0, "é‡èƒ½æœ€ä½å€æ•°", minval=0.0, step=0.1, group="åŠ å¯†å¸‚åœºç‰¹åŒ–")

// ============================================
// ğŸ“Œ æ˜¾ç¤ºé€‰é¡¹
// ============================================
show_ema_current = input.bool(true, "æ˜¾ç¤ºå½“å‰å‘¨æœŸEMAçº¿", group="æ˜¾ç¤º")
show_mtf_status = input.bool(true, "æ˜¾ç¤ºå¤šæ—¶é—´æ¡†æ¶çŠ¶æ€è¡¨", group="æ˜¾ç¤º")
show_score = input.bool(true, "åœ¨æ ‡ç­¾ä¸Šæ˜¾ç¤ºåˆ†æ•°", group="æ˜¾ç¤º")

// ============================================
// CMFè®¡ç®—å‡½æ•°
// ============================================
cmf_calc(len) =>
  ad = high == low ? 0 : ((2 * close - low - high) / (high - low)) * volume
  math.sum(ad, len) / math.sum(volume, len)

// ============================================
// ã€å‡çº§1ã€‘ä¸€æ¬¡securityè°ƒç”¨ - ä¼˜åŒ–æ€§èƒ½
// ============================================
get_ema_trend(string tf, float weight) =>
  // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼šEMAå¿«ã€EMAæ…¢ã€ATRã€ç¡®è®¤çŠ¶æ€
  [ef, es, atr_val, confirmed] = request.security(
    syminfo.tickerid, 
    tf,
    [ta.ema(close, ema_fast), ta.ema(close, ema_slow), ta.atr(atr_length), barstate.isconfirmed],
    gaps=barmerge.gaps_off, 
    lookahead=barmerge.lookahead_off
  )
  
  // é˜²é‡ç»˜ï¼šæœªç¡®è®¤çš„Kçº¿è¿”å›ä¸­æ€§
  if use_confirmed and not confirmed
    [0, ef, es, false, 0.0, atr_val]
  else
    // åœ¨å½“å‰æ—¶é—´æ¡†æ¶è®¡ç®—æ–œç‡ï¼ˆé¿å…è·¨å‘¨æœŸè®¡ç®—ï¼‰
    fast_slope = ef - ef[slope_length]
    slow_slope = es - es[slope_length]
    
    trend_result = 0
    score_result = 0.0
    
    // è¶‹åŠ¿åˆ¤æ–­ï¼šå¿«çº¿åœ¨ä¸Šä¸”ä¸¤çº¿éƒ½å‘ä¸Š = çœ‹æ¶¨
    if ef > es and fast_slope > 0 and slow_slope > 0
      trend_result := 1
      score_result := weight
    // å¿«çº¿åœ¨ä¸‹ä¸”ä¸¤çº¿éƒ½å‘ä¸‹ = çœ‹è·Œ
    else if ef < es and fast_slope < 0 and slow_slope < 0
      trend_result := -1
      score_result := weight
    
    [trend_result, ef, es, true, score_result, atr_val]

// ============================================
// è·å–4ä¸ªæ—¶é—´æ¡†æ¶çš„è¶‹åŠ¿
// ============================================
[trend1, ema_fast1, ema_slow1, confirmed1, score1, atr1] = get_ema_trend(tf1, weight1)
[trend2, ema_fast2, ema_slow2, confirmed2, score2, atr2] = get_ema_trend(tf2, weight2)
[trend3, ema_fast3, ema_slow3, confirmed3, score3, atr3] = get_ema_trend(tf3, weight3)
[trend4, ema_fast4, ema_slow4, confirmed4, score4, atr4] = get_ema_trend(tf4, weight4)

// è·å–é”šå®šTFçš„è¶‹åŠ¿
[anchor_trend, anchor_fast, anchor_slow, anchor_confirmed, anchor_score, anchor_atr] = get_ema_trend(anchor_tf, 0.0)

// ============================================
// ã€å‡çº§2ã€‘è¶‹åŠ¿å¼ºåº¦æ£€æŸ¥ - ATRå½’ä¸€åŒ–
// ============================================
// TF1 å¼ºåº¦æ£€æŸ¥
fast_slope1 = ema_fast1 - ema_fast1[slope_length]
slow_slope1 = ema_slow1 - ema_slow1[slope_length]
spread1 = math.abs(ema_fast1 - ema_slow1)
strong1 = math.abs(fast_slope1) >= slope_atr_mult * atr1 and 
          math.abs(slow_slope1) >= slope_atr_mult * atr1 and 
          spread1 >= spread_atr_mult * atr1

// TF2 å¼ºåº¦æ£€æŸ¥
fast_slope2 = ema_fast2 - ema_fast2[slope_length]
slow_slope2 = ema_slow2 - ema_slow2[slope_length]
spread2 = math.abs(ema_fast2 - ema_slow2)
strong2 = math.abs(fast_slope2) >= slope_atr_mult * atr2 and 
          math.abs(slow_slope2) >= slope_atr_mult * atr2 and 
          spread2 >= spread_atr_mult * atr2

// TF3 å¼ºåº¦æ£€æŸ¥
fast_slope3 = ema_fast3 - ema_fast3[slope_length]
slow_slope3 = ema_slow3 - ema_slow3[slope_length]
spread3 = math.abs(ema_fast3 - ema_slow3)
strong3 = math.abs(fast_slope3) >= slope_atr_mult * atr3 and 
          math.abs(slow_slope3) >= slope_atr_mult * atr3 and 
          spread3 >= spread_atr_mult * atr3

// TF4 å¼ºåº¦æ£€æŸ¥
fast_slope4 = ema_fast4 - ema_fast4[slope_length]
slow_slope4 = ema_slow4 - ema_slow4[slope_length]
spread4 = math.abs(ema_fast4 - ema_slow4)
strong4 = math.abs(fast_slope4) >= slope_atr_mult * atr4 and 
          math.abs(slow_slope4) >= slope_atr_mult * atr4 and 
          spread4 >= spread_atr_mult * atr4

// ============================================
// ã€å‡çº§3ã€‘æŒä¹…åº¦ä¸ä¸€è‡´æ€§çª—å£æ£€æŸ¥
// ============================================
// TF1 æŒä¹…åº¦ä¸ä¸€è‡´æ€§
bull_cond1 = trend1 == 1 and strong1
bear_cond1 = trend1 == -1 and strong1
persist_bull1 = persist_len == 0 or ta.barssince(not bull_cond1) >= persist_len
persist_bear1 = persist_len == 0 or ta.barssince(not bear_cond1) >= persist_len
cons_bull1 = ta.sum(bull_cond1 ? 1 : 0, win_len) >= win_need
cons_bear1 = ta.sum(bear_cond1 ? 1 : 0, win_len) >= win_need
valid1_bull = bull_cond1 and persist_bull1 and cons_bull1
valid1_bear = bear_cond1 and persist_bear1 and cons_bear1

// TF2 æŒä¹…åº¦ä¸ä¸€è‡´æ€§
bull_cond2 = trend2 == 1 and strong2
bear_cond2 = trend2 == -1 and strong2
persist_bull2 = persist_len == 0 or ta.barssince(not bull_cond2) >= persist_len
persist_bear2 = persist_len == 0 or ta.barssince(not bear_cond2) >= persist_len
cons_bull2 = ta.sum(bull_cond2 ? 1 : 0, win_len) >= win_need
cons_bear2 = ta.sum(bear_cond2 ? 1 : 0, win_len) >= win_need
valid2_bull = bull_cond2 and persist_bull2 and cons_bull2
valid2_bear = bear_cond2 and persist_bear2 and cons_bear2

// TF3 æŒä¹…åº¦ä¸ä¸€è‡´æ€§
bull_cond3 = trend3 == 1 and strong3
bear_cond3 = trend3 == -1 and strong3
persist_bull3 = persist_len == 0 or ta.barssince(not bull_cond3) >= persist_len
persist_bear3 = persist_len == 0 or ta.barssince(not bear_cond3) >= persist_len
cons_bull3 = ta.sum(bull_cond3 ? 1 : 0, win_len) >= win_need
cons_bear3 = ta.sum(bear_cond3 ? 1 : 0, win_len) >= win_need
valid3_bull = bull_cond3 and persist_bull3 and cons_bull3
valid3_bear = bear_cond3 and persist_bear3 and cons_bear3

// TF4 æŒä¹…åº¦ä¸ä¸€è‡´æ€§
bull_cond4 = trend4 == 1 and strong4
bear_cond4 = trend4 == -1 and strong4
persist_bull4 = persist_len == 0 or ta.barssince(not bull_cond4) >= persist_len
persist_bear4 = persist_len == 0 or ta.barssince(not bear_cond4) >= persist_len
cons_bull4 = ta.sum(bull_cond4 ? 1 : 0, win_len) >= win_need
cons_bear4 = ta.sum(bear_cond4 ? 1 : 0, win_len) >= win_need
valid4_bull = bull_cond4 and persist_bull4 and cons_bull4
valid4_bear = bear_cond4 and persist_bear4 and cons_bear4

// é‡æ–°è®¡ç®—åˆ†æ•°ï¼ˆåªæœ‰é€šè¿‡å¼ºåº¦+æŒä¹…åº¦+ä¸€è‡´æ€§çš„æ‰ç»™åˆ†ï¼‰
final_score1_bull = valid1_bull ? score1 : 0.0
final_score1_bear = valid1_bear ? score1 : 0.0
final_score2_bull = valid2_bull ? score2 : 0.0
final_score2_bear = valid2_bear ? score2 : 0.0
final_score3_bull = valid3_bull ? score3 : 0.0
final_score3_bear = valid3_bear ? score3 : 0.0
final_score4_bull = valid4_bull ? score4 : 0.0
final_score4_bear = valid4_bear ? score4 : 0.0

// ============================================
// åŠ æƒæŠ•ç¥¨è®¡ç®—
// ============================================
bullish_score = final_score1_bull + final_score2_bull + final_score3_bull + final_score4_bull
bearish_score = final_score1_bear + final_score2_bear + final_score3_bear + final_score4_bear
max_score = weight1 + weight2 + weight3 + weight4

// ============================================
// ã€å‡çº§6ã€‘é”šå®šTFé—¨æ§ä¸æ”¶ç›˜åŒæ­¥
// ============================================
gate_passed_bull = not gate_mode or anchor_trend == 1
gate_passed_bear = not gate_mode or anchor_trend == -1

// æ”¶ç›˜åŒæ­¥ï¼šåªåœ¨é”šå®šTFçš„Kçº¿æ”¶ç›˜æ—¶å…è®¸ä¿¡å·
anchor_bar_closed = request.security(
  syminfo.tickerid, 
  anchor_tf, 
  barstate.isconfirmed, 
  gaps=barmerge.gaps_off, 
  lookahead=barmerge.lookahead_off
)
final_gate = not sync_on_close or anchor_bar_closed

// ============================================
// ATRæ³¢åŠ¨ç‡è¿‡æ»¤
// ============================================
current_atr = ta.atr(atr_length)
atr_percent = current_atr / close * 100
atr_pass = not use_atr_filter or atr_percent >= atr_threshold

// ============================================
// CMFèµ„é‡‘æµè¿‡æ»¤ï¼ˆå¯¹ç§°é€»è¾‘ï¼‰
// ============================================
cmf_val = cmf_calc(cmf_length)
cmf_pass_bull = not use_cmf_filter or cmf_val > cmf_threshold
cmf_pass_bear = not use_cmf_filter or cmf_val < -cmf_threshold

// ============================================
// ã€å‡çº§4ã€‘ç›¸å¯¹å¼ºåº¦è¿‡æ»¤
// ============================================
bench_close = request.security(bench_sym, timeframe.period, close, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rs = close / bench_close
rs_sma = ta.sma(rs, rs_len)
rs_ok_long = not use_rs or rs > rs_sma
rs_ok_short = not use_rs or rs < rs_sma

// ============================================
// ã€å‡çº§5ã€‘é‡èƒ½è¿‡æ»¤
// ============================================
vol_sma = ta.sma(volume, vol_ma_len)
vol_ok = not use_vol_filter or volume > vol_sma * vol_mult

// ============================================
// ä¿¡å·ç”Ÿæˆé€»è¾‘ï¼ˆæ•´åˆæ‰€æœ‰è¿‡æ»¤å™¨ï¼‰
// ============================================
var int last_signal_bar = na
cooldown_passed = na(last_signal_bar) or (bar_index - last_signal_bar) >= cooldown_bars

buy_signal = bullish_score >= signal_threshold and 
             gate_passed_bull and 
             final_gate and 
             atr_pass and 
             cmf_pass_bull and 
             rs_ok_long and 
             vol_ok and 
             cooldown_passed

sell_signal = bearish_score >= signal_threshold and 
              gate_passed_bear and 
              final_gate and 
              atr_pass and 
              cmf_pass_bear and 
              rs_ok_short and 
              vol_ok and 
              cooldown_passed

buy_signal_new = buy_signal and not buy_signal[1]
sell_signal_new = sell_signal and not sell_signal[1]

if buy_signal_new or sell_signal_new
  last_signal_bar := bar_index

// ============================================
// ç»˜åˆ¶å½“å‰å‘¨æœŸEMAçº¿
// ============================================
current_ema_fast = ta.ema(close, ema_fast)
current_ema_slow = ta.ema(close, ema_slow)

plot(show_ema_current ? current_ema_fast : na, "EMA" + str.tostring(ema_fast), color=color.new(color.blue, 0), linewidth=2)
plot(show_ema_current ? current_ema_slow : na, "EMA" + str.tostring(ema_slow), color=color.new(color.orange, 0), linewidth=2)

// ============================================
// ç»˜åˆ¶ä¹°å–ä¿¡å·ç®­å¤´
// ============================================
plotshape(buy_signal_new, "ä¹°å…¥ä¿¡å·", shape.triangleup, location.belowbar, color=color.new(color.green, 0), size=size.normal)
plotshape(sell_signal_new, "å–å‡ºä¿¡å·", shape.triangledown, location.abovebar, color=color.new(color.red, 0), size=size.normal)

// ============================================
// ä¿¡å·æ ‡ç­¾ï¼ˆæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼‰
// ============================================
if buy_signal_new
  label_text = "ğŸš€ ä¹°å…¥ä¿¡å·"
  if show_score
    label_text := label_text + "\nåˆ†æ•°: " + str.tostring(bullish_score, "#.#") + "/" + str.tostring(max_score, "#.#")
  label_text := label_text + "\nç¡®è®¤å‘¨æœŸ:"
  if valid1_bull
    label_text := label_text + "\nâœ“ " + tf1 + " [" + str.tostring(weight1, "#.#") + "]"
  if valid2_bull
    label_text := label_text + "\nâœ“ " + tf2 + " [" + str.tostring(weight2, "#.#") + "]"
  if valid3_bull
    label_text := label_text + "\nâœ“ " + tf3 + " [" + str.tostring(weight3, "#.#") + "]"
  if valid4_bull
    label_text := label_text + "\nâœ“ " + tf4 + " [" + str.tostring(weight4, "#.#") + "]"
  
  label.new(bar_index, low, label_text, style=label.style_label_up, color=color.new(color.green, 80), textcolor=color.white, size=size.small)

if sell_signal_new
  label_text = "ğŸ”» å–å‡ºä¿¡å·"
  if show_score
    label_text := label_text + "\nåˆ†æ•°: " + str.tostring(bearish_score, "#.#") + "/" + str.tostring(max_score, "#.#")
  label_text := label_text + "\nç¡®è®¤å‘¨æœŸ:"
  if valid1_bear
    label_text := label_text + "\nâœ“ " + tf1 + " [" + str.tostring(weight1, "#.#") + "]"
  if valid2_bear
    label_text := label_text + "\nâœ“ " + tf2 + " [" + str.tostring(weight2, "#.#") + "]"
  if valid3_bear
    label_text := label_text + "\nâœ“ " + tf3 + " [" + str.tostring(weight3, "#.#") + "]"
  if valid4_bear
    label_text := label_text + "\nâœ“ " + tf4 + " [" + str.tostring(weight4, "#.#") + "]"
  
  label.new(bar_index, high, label_text, style=label.style_label_down, color=color.new(color.red, 80), textcolor=color.white, size=size.small)

// ============================================
// çŠ¶æ€è¡¨æ ¼ï¼ˆå¢å¼ºç‰ˆï¼‰
// ============================================
if show_mtf_status and barstate.islast
  var table status_table = table.new(position.top_right, 5, 7, border_width=1, border_color=color.gray)
  
  if barstate.isfirst
    table.cell(status_table, 0, 0, "å‘¨æœŸ", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 1, 0, "è¶‹åŠ¿", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 2, 0, "å¼ºåº¦", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 3, 0, "æƒé‡", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(status_table, 4, 0, "å¾—åˆ†", bgcolor=color.new(color.gray, 70), text_color=color.white)
  
  // TF1
  table.cell(status_table, 0, 1, tf1, text_color=color.white)
  table.cell(status_table, 1, 1, trend1 == 1 ? "â†‘" : trend1 == -1 ? "â†“" : "â€”", 
    bgcolor=trend1 == 1 ? color.new(color.green, 70) : trend1 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 2, 1, strong1 ? "âœ“" : "âœ—", text_color=strong1 ? color.lime : color.red)
  table.cell(status_table, 3, 1, str.tostring(weight1, "#.#"), text_color=color.white)
  table.cell(status_table, 4, 1, str.tostring(valid1_bull ? final_score1_bull : valid1_bear ? final_score1_bear : 0, "#.#"), text_color=color.white)
  
  // TF2
  table.cell(status_table, 0, 2, tf2, text_color=color.white)
  table.cell(status_table, 1, 2, trend2 == 1 ? "â†‘" : trend2 == -1 ? "â†“" : "â€”", 
    bgcolor=trend2 == 1 ? color.new(color.green, 70) : trend2 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 2, 2, strong2 ? "âœ“" : "âœ—", text_color=strong2 ? color.lime : color.red)
  table.cell(status_table, 3, 2, str.tostring(weight2, "#.#"), text_color=color.white)
  table.cell(status_table, 4, 2, str.tostring(valid2_bull ? final_score2_bull : valid2_bear ? final_score2_bear : 0, "#.#"), text_color=color.white)
  
  // TF3
  table.cell(status_table, 0, 3, tf3, text_color=color.white)
  table.cell(status_table, 1, 3, trend3 == 1 ? "â†‘" : trend3 == -1 ? "â†“" : "â€”", 
    bgcolor=trend3 == 1 ? color.new(color.green, 70) : trend3 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 2, 3, strong3 ? "âœ“" : "âœ—", text_color=strong3 ? color.lime : color.red)
  table.cell(status_table, 3, 3, str.tostring(weight3, "#.#"), text_color=color.white)
  table.cell(status_table, 4, 3, str.tostring(valid3_bull ? final_score3_bull : valid3_bear ? final_score3_bear : 0, "#.#"), text_color=color.white)
  
  // TF4
  table.cell(status_table, 0, 4, tf4, text_color=color.white)
  table.cell(status_table, 1, 4, trend4 == 1 ? "â†‘" : trend4 == -1 ? "â†“" : "â€”", 
    bgcolor=trend4 == 1 ? color.new(color.green, 70) : trend4 == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 2, 4, strong4 ? "âœ“" : "âœ—", text_color=strong4 ? color.lime : color.red)
  table.cell(status_table, 3, 4, str.tostring(weight4, "#.#"), text_color=color.white)
  table.cell(status_table, 4, 4, str.tostring(valid4_bull ? final_score4_bull : valid4_bear ? final_score4_bear : 0, "#.#"), text_color=color.white)
  
  // é”šå®šTFçŠ¶æ€
  table.cell(status_table, 0, 5, "é”šå®š", bgcolor=color.new(color.purple, 80), text_color=color.white)
  table.cell(status_table, 1, 5, anchor_tf, text_color=color.white)
  table.cell(status_table, 2, 5, anchor_trend == 1 ? "â†‘" : anchor_trend == -1 ? "â†“" : "â€”", 
    bgcolor=anchor_trend == 1 ? color.new(color.green, 70) : anchor_trend == -1 ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 3, 5, gate_mode ? "å¼€å¯" : "å…³é—­", text_color=gate_mode ? color.yellow : color.gray)
  table.cell(status_table, 4, 5, sync_on_close ? "åŒæ­¥" : "æ»šåŠ¨", text_color=sync_on_close ? color.yellow : color.gray)
  
  // æ€»åˆ†
  table.cell(status_table, 0, 6, "æ€»åˆ†", bgcolor=color.new(color.gray, 70), text_color=color.white)
  table.cell(status_table, 1, 6, bullish_score > bearish_score ? "â†‘" : bearish_score > bullish_score ? "â†“" : "â€”", 
    bgcolor=bullish_score > bearish_score ? color.new(color.green, 70) : bearish_score > bullish_score ? color.new(color.red, 70) : color.new(color.gray, 80), text_color=color.white)
  table.cell(status_table, 2, 6, "", text_color=color.white)
  table.cell(status_table, 3, 6, str.tostring(max_score, "#.#"), text_color=color.white)
  table.cell(status_table, 4, 6, str.tostring(math.max(bullish_score, bearish_score), "#.#") + "/" + str.tostring(signal_threshold, "#.#"), 
    text_color=bullish_score >= signal_threshold or bearish_score >= signal_threshold ? color.yellow : color.white)

// ============================================
// æŠ¥è­¦æ¡ä»¶
// ============================================
alertcondition(buy_signal_new, "ä¹°å…¥ä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤ä¹°å…¥ä¿¡å·")
alertcondition(sell_signal_new, "å–å‡ºä¿¡å·", "å¤šæ—¶é—´æ¡†æ¶ç¡®è®¤å–å‡ºä¿¡å·")

// èƒŒæ™¯é«˜äº®
bgcolor(buy_signal ? color.new(color.green, 95) : sell_signal ? color.new(color.red, 95) : na)
